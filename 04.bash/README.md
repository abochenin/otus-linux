# Домашнее задание 4.bash
Домашнее задание

Пишем скрипт

Цель: В результате этого ДЗ вы научитесь писать простые скрипты, решающие нужны задачи, такие как мониторинг кол-ва ошибок в логах Освоите работу с файлами, поиском, парсингом текста, управлением блокировками
написать скрипт для крона, который раз в час присылает на заданную почту

- X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
- Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
- все ошибки c момента последнего запуска
- список всех кодов возврата с указанием их кол-ва с момента последнего запуска

в письме должен быть прописан обрабатываемый временной диапазон

должна быть реализована защита от мультизапуска

Критерии оценки:
трапы и функции, а также sed и find +1 балл

---
## Описание 
Задача состоит из модулей.

1. Основной скрипт **report.sh**, анализирующий nginx_log, и формирующий требуемый в домашнем задании отчет.
2. Вспомогательный скрипт **log_maker_daemon.sh**.
 
У нас лабораторные условия, файл nginx_log не с живой системы, и лог, собственно, не меняется. В него не добавляются записи, поэтому повторный запуск скрипта из пункта 1 будет давать путстые отчеты, что не интересно в рамках поставленной задачи. Для решения этой проблемы подготовлен логмейкер-демон, который имитирует постояно пополняемый лог-файл nginx_log.

## logmaker_daemon.sh
Этот демон в процессе своей работы раз в пять секунд читает несколько строк из файла big_nginx_log и дописывает их в nginx_log. 

Число строк выбирается случайно в интервале от 3 до 10. То есть каждые пять секунд в файл  nginx_log добавляются в среднем 7 новых строк.

Работу демона можно прервать любым образом (kill, term). Демон запоминает состояние в файле logmaker_daemon.conf, и после повторного запуска продолжит работу с прерванного места.

## Отчет
Скрипт report.sh выводит отчет. Пример выводимого отчета
```bash
$ ./report.sh 
=== Анализируемый период ===
Начинаем со строки 38, добавилось строк 26367
12/Dec/2015:18:57:24
24/Jan/2016:13:56:52

=== Самые активные клиенты  ===
Запросов        IP_Address
   1929 148.251.50.49
    896 205.167.170.15
    734 52.22.118.215
    709 84.112.161.41
    438 37.1.206.196

=== Самые часто запрашиваемые URLs ===
Запросов        URL
   6074 /administrator/index.php
   2682 /administrator/
   1441 /
    985 /templates/_system/css/general.css
    472 /robots.txt

=== Список всех кодов возврата за период ===
  Число Код_возврата
  22950 200
   2675 404
    636 304
     84 301
     12 500
      6 405
      3 206
      1 501
Выборочный анализ ошибок на примере 403 и 500

=== Ошибка 403 и список URL (первых 10 строк)

=== Ошибка 500 и список URL (первых 10 строк)
/administrator/
/administrator/
/administrator/
/
/administrator/
/administrator/
/administrator/
/administrator/
/administrator/
/administrator/index.php/
```

В случае попытки одновременного запуска двух экземпляров отчета, будет выведено сообщение
```bash
$ ./report.sh
Скрипт уже запущен! Возможность повторного запуска заблокирована по условиям задачи
```

Также в скрипте обрабатывается несколько типов сигналов, например SIGINT, SIGHUP, EXIT. В этом случае скрипт сообщит об этом примерно так:

```bash
$ ./report.sh
sleep 100
^CSIGINT trapped
```


## Подготовка к запуску

Создаем окружение из подготовленного vagrant-файла

```bash
$ vagrant up
$ vagrant ssh
[vagrant@hw4 ~]$ cd /vagrant 
```



## Инструкция по запуску

Сначала запускаем демона для имитации активно пополняемого лога

./log_maker_daemon.sh >/dev/null &

Подождать секунд 10 для наполнения лога

./report.sh

Подождать несколько секунд

./report.sh

и т.д.

В конце остановить демона


```bash
$ jobs
[1]+  Running                 ./log_maker_daemon.sh &


$ kill -9 `ps -ef|grep log_maker_daemon.sh|grep -v grep|awk '{print $2}'`

[1]+  Убито              ./log_maker_daemon.sh
$
```

