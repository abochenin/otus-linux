# Домашнее задание 14.backup
Настраиваем бэкапы
Настроить стенд Vagrant с двумя виртуальными машинами server и client.

Настроить политику бэкапа директории /etc с клиента:
1) Полный бэкап - раз в день
2) Инкрементальный - каждые 10 минут
3) Дифференциальный - каждые 30 минут

Запустить систему на два часа. Для сдачи ДЗ приложить list jobs, list files jobid=<id>
и сами конфиги bacula-*

* Настроить доп. Опции - сжатие, шифрование, дедупликация 
---


## Подготовка к запуску
Для работы скрипта 
Создаем окружение из подготовленного vagrant-файла
```bash
$ vagrant up
```

## Описание
В запущенной раннее виртуальной машине скрипт провижининга выполнил требуемые действия.
```bash
    client: Running ansible-playbook...

PLAY [настройка сервера borgbackup] ********************************************
skipping: no hosts matched

PLAY [Настройка клиента borg] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [client]

TASK [client : Подключение репо EPEL Repo] *************************************
changed: [client]

TASK [client : Установка пакетов] **********************************************
changed: [client]

TASK [client : Добавение записей в /etc/hosts] *********************************
changed: [client] => (item=192.168.50.11 server)
changed: [client] => (item=192.168.50.12 client)

TASK [client : Установка пакета borgbackup] ************************************
changed: [client]

TASK [client : Создаем каталог ~root/.ssh/] ************************************
changed: [client]

TASK [client : Копируем приватный ключ клиента в домашний каталог ~root/.ssh/] ***
changed: [client]

TASK [client : И обновляем known_hosts, чтобы избавиться от запроса подтверждения при первичном подключении] ***
changed: [client]

TASK [client : Инициализируем бакап хранилище] *********************************
changed: [client]

TASK [client : И создаем задание планировщика для регулярного бакапа] **********
changed: [client]

PLAY RECAP *********************************************************************
client                     : ok=10   changed=9    unreachable=0    failed=0 
```

## Проверки
Нужно дать поработать виртуалкам некторое время (час-два)
```bash
$ vagrant ssh client
[vagrant@client ~]$ sudo su -
```

Видно, что в кроне есть запланированные задания
```bash
[root@client ~]# crontab -l
#Ansible: etckeep
*/10 * * * * borg create borg@server:backup::"etckeep-{now:\%Y-\%m-\%d_\%H:\%M:\%S}" /etc
```

И они успешно отрабатывают и выполняют резервное копирование с заданными параметрами. Видно, что каждые 10 минут выполнялось 
резервное копирование по шаблону etckeep.


```bash
[root@client ~]#  borg list borg@server:backup
etckeep-2019-10-02_05:20:02          Wed, 2019-10-02 05:20:03 [483ec3bd996b760c11ae1d0dfc590e6d5ff68522a86520526b4e0b7fa89114aa]
etckeep-2019-10-02_05:30:01          Wed, 2019-10-02 05:30:02 [8472cef98d9a751f408a23c34885a774f4453bcd0c3afa7db51e396439998314]
etckeep-2019-10-02_05:40:02          Wed, 2019-10-02 05:40:03 [5ea54ef6740f9ab8157fda672c79bf9068d9b4dc55f66e9a8b021b758d10f83d]
etckeep-2019-10-02_05:50:01          Wed, 2019-10-02 05:50:02 [0c85306af869e74cfe9f63e94340911859421aa328f99dc07ca2b58d5fbab917]
etckeep-2019-10-02_06:00:01          Wed, 2019-10-02 06:00:02 [19d77cdb15dada1c2742a36185c856fd107b4b4d5ede8ba01026887b9473c504]
etckeep-2019-10-02_06:10:02          Wed, 2019-10-02 06:10:03 [2bd72f0a43c70e675b0e219d7b76a06b27393caa3b0447da91153dd511a55e0f]
etckeep-2019-10-02_06:20:01          Wed, 2019-10-02 06:20:02 [3d6473055174966ea4a556be1f7e420b3dbc7b7e767980b0637c6a8617985caf]
```

Особенность borgbackup в том, что нет разделения на инкрементальные, дифференциальные, полные бакапы. Любой бакап - полный, но с учетом эффективной 
дедупликации и компрессии, время выполнения полных бакапов - как у инкрементных. Копируются только изменившиеся с последнего бакапа файлы.

```bash
[root@client ~]#  borg info borg@server:backup
Repository ID: 0275fc5b42505659abcb4a21da7ad0b428666ff43b6a35e9b4ddea26b6d25253
Location: ssh://borg@server/./backup
Encrypted: No
Cache: /root/.cache/borg/0275fc5b42505659abcb4a21da7ad0b428666ff43b6a35e9b4ddea26b6d25253
Security dir: /root/.config/borg/security/0275fc5b42505659abcb4a21da7ad0b428666ff43b6a35e9b4ddea26b6d25253
------------------------------------------------------------------------------
                       Original size      Compressed size    Deduplicated size
All archives:              223.10 MB            105.93 MB             11.89 MB

                       Unique chunks         Total chunks
Chunk index:                    1302                13619
```

Видно, что в данном случае дедупликация позволяет сократить место под бакапы почти в 20 раз
