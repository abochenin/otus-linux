## Домашнее задание 26.nginx
Простая защита от DDOS
Написать конфигурацию nginx, которая даёт доступ клиенту только с определенной cookie.
Если у клиента её нет, нужно выполнить редирект на location, в котором кука будет добавлена, после чего клиент будет обратно отправлен (редирект) на запрашиваемый ресурс.

Смысл: умные боты попадаются редко, тупые боты по редиректам с куками два раза не пойдут

Для выполнения ДЗ понадобятся
https://nginx.org/ru/docs/http/ngx_http_rewrite_module.html
https://nginx.org/ru/docs/http/ngx_http_headers_module.html 

## Подготовка
Создаем виртуалки
```bash
vagrant up
```

## Проверки
В конфигурацию nginx скриптами провижена были добавлены блоки
```bash
       location /setcookie {
          add_header "Set-Cookie" "access=secret" ;
          return 302 $cookie_query; #/index.html;
        }
```

```bash
        location / {
          if ($cookie_access != "secret") {
            add_header "Set-Cookie" "query=$request_uri";
            return 302 /setcookie;
          }
        }
```

Для проверки выполним несколько команд, подключившись к виртуалке

```bash
vagrant ssh sever
```

Первый запрос к странице, причем куки сохраним для дальнейшего использования в файле cookie1.txt

```bash
[root@server ~]# curl -Ic cookie1.txt http://localhost/index.html
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.16.1
Date: Mon, 25 Nov 2019 12:22:33 GMT
Content-Type: text/html
Content-Length: 145
Location: http://localhost/setcookie
Connection: keep-alive
Set-Cookie: query=/index.html

[root@server ~]# cat cookie1.txt 
# Netscape HTTP Cookie File
# http://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

localhost	FALSE	/	FALSE	0	query	/index.html
```

Видно, что сработало правило перенаправления на ресурс Location=http://localhost/setcookie, и в куке query сохранен первоначальный URL, к которому обратился клиент 
Используя куки из cookie1.txt, обращаемся на адрес перенаправления

```bash
[root@server ~]# curl -Ib cookie1.txt -c cookie2.txt http://localhost/setcookie
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.16.1
Date: Mon, 25 Nov 2019 12:23:35 GMT
Content-Type: text/html
Content-Length: 145
Location: http://localhost/index.html
Connection: keep-alive
Set-Cookie: access=secret

[root@server ~]# cat cookie2.txt 
# Netscape HTTP Cookie File
# http://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

localhost	FALSE	/	FALSE	0	query	/index.html
localhost	FALSE	/	FALSE	0	access	secret
```

Видно, что установлены новые куки query, access и сработало правило перенаправления на ресурс Location=http://localhost/index.html
Используя куки из cookie2.txt, обращаемся на адрес перенаправления


```bash
[root@server ~]# curl -Ib cookie2.txt http://localhost/index.html
HTTP/1.1 200 OK
Server: nginx/1.16.1
Date: Mon, 25 Nov 2019 12:24:22 GMT
Content-Type: text/html
Content-Length: 4833
Last-Modified: Fri, 16 May 2014 15:12:48 GMT
Connection: keep-alive
ETag: "53762af0-12e1"
Accept-Ranges: bytes
```

И получаем код возврата 200, что и требовалось.
